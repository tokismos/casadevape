(function(b){b.widget("lws.lws_autocomplete",{options:{css:"",cssColor:"",readOnly:true,sharedElt:undefined,sharedSource:"source",sharedData:"lws_autocomplete"},value:function(a){if(a===undefined){return this._getOption().value}var d=b.grep(this.remote.concat(this.local()),function(c){return c.value==a});if(d.length>0){this.input.val(this._setOption(d[0]).text())}else{this.input.val(a);this.element.empty();this.element.val(a)}},local:function(a){if(a!==undefined){if(!Array.isArray(a)){a=Object.keys(a).map(function(d){return a[d]})}this.options.sharedElt.data(this.options.sharedData,a)}return this.options.sharedElt.data(this.options.sharedData)},_create:function(){var a="lws-autocomplete";if(this.element.data("class")!=undefined){a+=(" "+this.element.data("class"))}this.ajax=(this.element.data("ajax")!=undefined?this.element.data("ajax"):undefined);this.wrapper=b("<div>").addClass(a).insertAfter(this.element);this.textbox=b("<div>").appendTo(this.wrapper);if(this.options.css!=""){this.wrapper.addClass(this.options.css)}if(this.options.sharedElt==undefined){this.options.sharedElt=this.element}this.local([]);this.remote=[];this.lastTerm="";this.minSearch=(this.element.data("minsearch")!=undefined?this.element.data("minsearch"):3);this.minOption=(this.element.data("minoption")!=undefined?this.element.data("minoption"):0);this.spec=this.element.data("spec");this.element.hide();this._grabOptions();this._createAutocomplete();this._createShowAllButton();this._on(true,this.element,{change:function(){var d=this._getOption();if(this.input.val()!=d.label){this.input.val(this._setOption(d).text())}}})},_createAutocomplete:function(){var a={source:b.proxy(this,"_source")};if(this.element.data("delay")!=undefined){a.delay=this.element.data("delay")}else{if(this.ajax==undefined){a.delay=0}}if(this.element.data("minlength")!=undefined){a.minLength=this.element.data("minlength")}else{if(this.ajax==undefined){a.minLength=0}}this.input=b("<input>").appendTo(this.textbox).val(this._getOption().label).attr("title","").addClass("lws-autocomplete-input ui-widget ui-widget-content ui-state-default ui-corner-left").autocomplete(a).tooltip({tooltipClass:"lws-tooltip lws-autocomplete-tooltip"});if(this.element.data("name")!=undefined){this.input.attr("name",this.element.data("name"))}if(this.element.data("placeholder")!=undefined){this.input.attr("placeholder",this.element.data("placeholder"))}this.input.data("ui-autocomplete")._renderItem=this._renderItem;this.input.data("ui-autocomplete")._resizeMenu=function(){var d=this.menu.element;d.outerWidth(this.element.outerWidth())};this._on(this.input,{autocompleteselect:"_apply",autocompletechange:"_removeIfInvalid",autocompletefocus:"_focusItem",autocompleteopen:"_shiftWidget"})},_createShowAllButton:function(){var h=this.input,g=false;var f="Show All Items";if(typeof lws_autocomplete_localize!=="undefined"){f=lws_autocomplete_localize.btnTitle}var a=b("<a>").attr("tabIndex",-1).attr("title",f).tooltip().appendTo(this.wrapper).removeClass("ui-corner-all").addClass("lws-autocomplete-toggle lws-icon-select_arrow_down");if(this.options.cssColor!=""){a.addClass(this.options.cssColor)}a.on("mousedown",function(){g=h.autocomplete("widget").is(":visible")});a.on("click",function(){h.trigger("focus");if(g){return}var c=h.autocomplete("option","minLength");h.autocomplete("option","minLength",0);h.autocomplete("search","");h.autocomplete("option","minLength",c)})},_shiftWidget:function(){var a=this.input.autocomplete("widget").offset();this.input.autocomplete("widget").offset({top:(a.top+2),left:(a.left-2)})},_apply:function(a,d){this.input.val(this._setOption(d.item).text());return false},_focusItem:function(a,d){return false},_grabOptions:function(){if(this.options.sharedElt.data(this.options.sharedSource)!=undefined){this.local(lwsBase64.toObj(this.options.sharedElt.data(this.options.sharedSource)))}else{var a=[];this.element.children("option").each(function(){var e=b(this);var f={value:e.val(),label:e.html()};if(e.data("detail")!=undefined){f.detail=e.data("detail")}a.push(f)});this.local(a)}},_getOption:function(){var a=this.element.val();var d=b.grep(this.remote.concat(this.local()),function(c){return c.value==a});return(d.length>0?d[0]:{value:"",label:""})},_setOption:function(f){var a=this.element.val();this.element.empty();var e=b("<option>").attr("value",f.value).html(f.label).attr("selected","selected");this.element.append(e);this.element.val(f.value);if(a!=this.element.val()){this.element.trigger("change")}return e},_source:function(e,a){if(this.ajax!=undefined){if(e.term.length>=this.minSearch){this._sourceRemote(e,a)}else{var f=this._filterLocal(e);if(f.length<=this.minOption){this._sourceRemote(e,a)}else{a(f)}}}else{a(this._filterLocal(e))}},_filterLocal:function(a){var d=new RegExp(b.ui.autocomplete.escapeRegex(a.term),"i");return b.map(this.local(),function(c){if(c.value&&(!a.term||d.test(c.label))){return c}})},_sourceRemote:function(h,a){if(this.lastTerm.length>0&&h.term.indexOf(this.lastTerm)>=0){var g=new RegExp(b.ui.autocomplete.escapeRegex(h.term),"i");a(b.map(this.remote,function(c){if(c.value&&(!h.term||g.test(c.label))){return c}}))}else{var j={action:this.ajax,term:h.term};if(this.spec!=undefined){j.spec=this.spec}var i=this;b.getJSON(lws_ajax_url,j,function(c){i.remote=[];if(null==c){i._tooltip("Autocomplete ressource error.")}else{if(0===c){i._tooltip("Autocomplete action not found.")}else{b.each(c,function(e,d){i.remote.push(d)})}}a(i.remote);i.lastTerm=h.term}).fail(function(d,c,e){a(i.remote);i._tooltip("Autocomplete loading error, status: "+c+", error: "+e)})}},_renderItem:function(f,e){var a=(typeof e.detail!=="undefined"?e.detail:e.label);return b("<li>").attr("data-value",e.value).append(a).appendTo(f)},_removeIfInvalid:function(l,k){if(k.item){return}var h=this.input.val();var i=b.ui.autocomplete.escapeRegex(h);if(!this.options.readOnly){i="^"+i+"$"}var j=new RegExp(i,"i");if(this._setLastChoice(this.remote,j)){return false}if(this._setLastChoice(this.local(),j)){return false}if(this.options.readOnly){this.input.val("");this.element.val("");this.input.autocomplete("instance").term="";this._tooltip(h+(typeof lws_autocomplete_localize!=="undefined"?lws_autocomplete_localize.notMatch:" didn't match any items"))}else{var a={label:h,value:h};this.local().push(a);this.input.val(this._setOption(a).text())}},_setLastChoice:function(f,e){var a=b.map(f,function(c){if(c.value&&e.test(c.label)){return c}});if(a.length==1){this.input.val(this._setOption(a[0]).text());return true}return false},_tooltip:function(a){this.input.attr("title",a).tooltip("open");this._delay(function(){this.input.tooltip("close").attr("title","")},2500)},_destroy:function(){this.wrapper.remove();this.element.show()}})})(jQuery);jQuery(function(b){b(".lws_autocomplete").lws_autocomplete()});