(function(b){b.widget("lws.lac_model",{options:{mode:"autocomplete",origin:undefined,count:20},_create:function(){this.originsList=[];this.currentOrigin={};this.keySource={};this.labelSource={};this.dataSource={};this.showMore=false;b.ajaxSettings.cache=false;this._setSource()},_bind:function(a,f,e){return function(){return a.apply(f,e)}},_setSource:function(){var a=b(this.options.origin.element);this.dataSource={};this.origdataSource={};this.ajax={};this.rawSource=undefined;if(a[0].nodeName=="SELECT"){for(var l=0;l<a[0].options.length;l++){var j={};j.value=a[0].options[l].value;j.label=a[0].options[l].text;if(a[0].options[l].closest("optgroup")!=null){var h=a[0].options[l].closest("optgroup").label;if(this.dataSource[h]==undefined){this.dataSource[h]={};this.dataSource[h].label=h;this.dataSource[h].group={};this.origdataSource[h]={};this.origdataSource[h].label=h;this.origdataSource[h].group={}}this.dataSource[h].group[l]=j;this.origdataSource[h].group[l]=j;this.keySource[a[0].options[l].value]=l}else{this.dataSource[l]=j;this.keySource[a[0].options[l].value]=l}}}if(this.options.origin.options.source!=undefined){this.rawSource=this.options.origin.options.source}if(a.data("source")!=undefined&&a.data("source")!=""){this.rawSource=lwsBase64.toObj(a.data("source"))}if(this.rawSource!=undefined){var m=0;var k=this;b.each(this.rawSource,function(d,c){k.dataSource[m]=c;k.keySource[c.value]=m;k.labelSource[c.label]=m;m+=1})}if(this.options.origin.options.ajax!=undefined){this.showMore=true;this.ajax.action=this.options.origin.options.ajax}if(a.data("ajax")!=undefined){this.showMore=true;this.ajax.action=a.data("ajax")}if(this.options.origin.options.spec!=undefined){this.ajax.spec=this.options.origin.options.spec}if(a.data("sourceurl")!=undefined){this.ajax.sourceurl=a.data("sourceurl")}if(this.options.origin.options.minsearch!=undefined){this.options.minsearch=this.options.origin.options.minsearch}if(a.data("minsearch")!=undefined){this.options.minsearch=a.data("minsearch")}if(this.options.origin.options.minoption!=undefined){this.options.minoption=this.options.origin.options.minoption}if(a.data("minoption")!=undefined){this.options.minoption=a.data("minoption")}if(this.options.origin.options.minlength!=undefined){this.options.minlength=this.options.origin.options.minlength}if(a.data("minlength")!=undefined){this.options.minlength=a.data("minlength")}},_setOrigin:function(a){var d=a.uuid;if(this.originsList[d]==""||this.originsList[d]==undefined){this.originsList[d]={};this.originsList[d].resLoad=a.resLoad;this.originsList[d].resChange=a.resChange;this.originsList[d].target=a;this.originsList[d].searched="";this.originsList[d].page=0;this.originsList[d].count=this.options.count}this.currentOrigin=this.originsList[d]},reInit:function(a){this._setOrigin(a);this.currentOrigin.page=0;this._setSource()},showMoreResults:function(a){this._setOrigin(a);this.currentOrigin.page+=1;this._remoteSource(this.currentOrigin.searched)},returnLabels:function(a,j,g){this.resCount=0;if(j!=undefined&&j!=""){this._setOrigin(j)}result=[];if(a!=undefined&&a!==false&&a.length>0&&a[0]!=""&&a[0]!=null){this.resCount=a.length;result=this._recursiveSearch(a,this.dataSource,true);if(this.resCount>0){if((this.ajax.sourceurl!=undefined&&this.ajax.sourceurl!="")||(this.ajax.action!=undefined&&this.ajax.action!="")){this._remoteSource(a,"init",true,true)}}var h=Object.keys(this.dataSource).length;for(let i=0;i<a.length;i++){var k=this.keySource[a[i]];if(k==undefined){result[a[i]]={};result[a[i]].value=a[i];result[a[i]].label=a[i];result[a[i]].html="";this.dataSource[h]=result[a[i]];this.keySource[a[i]]=h;this.labelSource[a[i]]=h;h+=1}}}this._sendBack(result,"init")},isSubChain:function(d,a){if(a!=undefined&&a!=""){this._setOrigin(a)}if(this.currentOrigin.searched.toLowerCase().substring(0,d.length)==d.toLowerCase()&&d.length<this.currentOrigin.searched.length){return true}return false},getValuesFromLabels:function(a,d){result=[];for(let i=0;i<a.length;i++){res=this.dataSource[this.labelSource[a[i]]];if(res==undefined||res==""){if(d==undefined||!d){res={};res.value=a[i];res.label=a[i];res.html="";result.push(res);this.dataSource[Object.keys(this.dataSource).length]=res}}else{result.push(res)}}return result},research:function(f,a,e){if((f==""||f==undefined)&&(e==undefined||e==false)){return}if(a!=undefined&&a!=""){this._setOrigin(a)}if(e==true){if(this.ajax.action!=undefined){this._remoteSource("")}else{this._sendBack(this.dataSource,"ok")}}else{if(f.length<this.options.minlength){return}if(f.toLowerCase().substring(0,this.currentOrigin.searched.length)==this.currentOrigin.searched.toLowerCase){resultData=this._recursiveSearch(f,this.dataSource,false);this._sendBack(resultData,"ok")}else{this.currentOrigin.searched=f;if(f.length>this.options.minsearch&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(f)}else{resultData=this._recursiveSearch(f,this.dataSource,false);if(resultData.length<this.options.minoption&&(this.ajax.sourceurl!=undefined||this.ajax.action!=undefined)){this._remoteSource(f)}else{this._sendBack(resultData,"ok")}}}}},getSource:function(){return this.dataSource},addToSource:function(e){var a=Object.keys(this.dataSource).length;for(var f in e){if(this.keySource[f]==""||this.keySource[f]==undefined){res={};res.value=e[f];res.label=e[f];res.html="";res.parent="";this.dataSource[a]=res;this.keySource[res.value]=a;this.labelSource[res.label]=a}}},clone:function(e){if(e==null||typeof(e)!="object"){return e}var a=new e.constructor();for(var f in e){a[f]=this.clone(e[f])}return a},_recursiveSearch:function(h,j,m){var a={};if(Object.keys(j).length==0){return a}for(var k in j){this.keySource[j[k].value]=k;this.labelSource[j[k].label]=k;if(j[k].group!=undefined){retour={};retour=this._recursiveSearch(h,j[k].group,m);if(!jQuery.isEmptyObject(retour)){a[k]=this.clone(j[k]);a[k].group=retour}}else{if(m==true){for(var l=0;l<h.length;l++){if(h[l]==j[k].value){a[k]=this.clone(j[k]);this.resCount-=1}}}else{researched=j[k].label.toLowerCase();if(b.isArray(h)){for(let l=0;l<h.length;l++){if(this.options.mode=="autocomplete"){if(researched.substring(0,h.length)==h[l].toLowerCase()){a[k]=this.clone(j[k]);this.resCount-=1}}else{if(this.options.mode=="research"){if(researched.search(h.toLowerCase())!=-1){a[k]=this.clone(j[k]);this.resCount-=1}}}}}else{if(this.options.mode=="autocomplete"){if(researched.substring(0,h.length)==h.toLowerCase()){a[k]=this.clone(j[k])}}else{if(this.options.mode=="research"){if(researched.search(h.toLowerCase())!=-1){a[k]=this.clone(j[k])}}}}}}}return a},_sendBack:function(d,a){result=[d,a,this.showMore];if(this.currentOrigin.resChange!=undefined){this.currentOrigin.resChange.fn.apply(this.currentOrigin.target,[result])}},_remoteSource:function(g,a,j){if(this.currentOrigin.resLoad!=undefined){this.currentOrigin.resLoad.fn.apply(this.currentOrigin.target)}var k={action:this.ajax.action,term:g,fromValue:j,count:this.currentOrigin.count,page:this.currentOrigin.page};if(a=="init"){k.term=""}k.fromValue=undefined;if(this.currentOrigin.target.element.data("spec")!=undefined){k.spec=this.currentOrigin.target.element.data("spec")}ajax_url=(this.ajax.sourceurl!=undefined)?this.ajax.sourceurl:lws_ajax_url;var h=this;b.getJSON(ajax_url,k,function(d){resultData={};if(null==d){status="Autocomplete ressource error."}else{if(0===d){status="Autocomplete action not found."}else{var c=Object.keys(h.dataSource).length;b.each(d,function(f,e){var m=h.keySource[e.value];if(m==undefined){h.dataSource[c]=e;h.keySource[e.value]=c;h.labelSource[e.label]=c;c+=1}else{h.dataSource[m]=e;h.labelSource[e.label]=m}});h.showMore=(Object.keys(d).length==h.currentOrigin.count);if(a!=undefined){status="init";h.resCount=g.length;resultData=h._recursiveSearch(g,h.dataSource,true);if(h.resCount>0){console.log("some items couldn't be found on datasource")}}else{status="ok";h.currentOrigin.searched=g;resultData=h._recursiveSearch(g,h.dataSource,false)}h._sendBack(resultData,status)}}}).fail(function(d,c,e){resultData=[];status="Autocomplete loading error, status: "+c+", error: "+e;if(noCallBack!=true){h._sendBack(resultData,status)}})}})})(jQuery);