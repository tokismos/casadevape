(function(b){b.widget("lws.lac_checklist",{options:{classe:"",name:"",placeholder:"",shared:false,addlabel:"Add",delay:300,minlength:0,minoptions:2,minsearch:1,rows:3},_create:function(){this.checkedList={};this.preventNext=false;this.initList=(this.element.data("value")!=undefined&&this.element.data("value").trim()!="")?lwsBase64.toObj(this.element.data("value")):undefined;this.name=this.element.prop("name");this.element.data("lw_name",this.name).prop("name","");this.colWidths=["auto","380px","187px","123px"];this.showMore=false;this._setOptions();this._createStructure();this.resLoad={};this.resLoad.target=this;this.resLoad.fn=this._ajaxLoading;this.resChange={};this.resChange.target=this;this.resChange.fn=this._resultChanged;this._manageModel();this.resList=b(this.model).lac_model("getSource");this._setResList(this.resList);this.container.on("click",".lac-tag-remove",this._bind(this._delTag,this));this.container.on("click",".lac-checklist-resicon",this._bind(this._toggleCheckList,this));this.container.on("click",".lac-checklist-basebutton",this._bind(this._openCheckList,this));this.container.on("click",".lac-checklist-searchbtn",this._bind(this._openSearch,this));this.container.on("click",".lac-checklist-resetbtn",this._bind(this._resetSearch,this));this.container.on("click",".lac-checklist-showmore",this._bind(this._showMore,this));this.container.on("click",".lac-checklist-close",this._bind(this._closeCheckList,this));this.container.on("click",".lac-checklist-item",this._bind(this._selectItem,this));this.container.on("keydown",this._bind(this._manageKeys,this));this.element.on("change",this._bind(this._changeElement,this));b(document).on("click",this._bind(this._manageFocus,this));var a=this;var e;var f=[];this.container.keyup(function(d,c){f[0]=d.key;f[1]=d.keyCode;sentData=[f];e&&clearTimeout(e);e=setTimeout(a._bindD(a._manageSearch,a,sentData),a.options.delay)})},_bind:function(a,d){return function(){return a.apply(d,arguments)}},_bindD:function(a,f,e){return function(){return a.apply(f,e)}},_setOptions:function(){if(this.element.data("placeholder")!=undefined){this.options.placeholder=this.element.data("placeholder")}if(this.element.data("delay")!=undefined){this.options.delay=this.element.data("delay")}if(this.element.data("class")!=undefined){this.options.classe=this.element.data("class")}if(this.element.data("shared")!=undefined){this.options.shared=this.element.data("shared")}if(this.element.data("name")!=undefined){this.options.name=this.element.data("name")}},_createStructure:function(){this.container=b("<div>",{"class":"lac-checklist-wrapper "}).append(b("<div>",{"class":"lac-checklist-top"}).append(b("<div>",{"class":"lac-checklist-combo"}).append(b("<div>",{"class":"lac-checklist-basebutton",html:this.options.placeholder})).append(b("<div>",{"class":"lac-checklist-searchdiv"}).append(b("<div>",{"class":"lac-checklist-searchbtn lws-icon-search"})).append(b("<input>",{"class":"lac-checklist-input "+this.options.classe,placeholder:"Search...",name:this.options.name})).append(b("<div>",{"class":"lac-checklist-resetbtn lws-icon-undo2"}))).append(b("<div>",{"class":"lac-checklist-close",html:"OK"}))).append(b("<div>",{"class":"lac-checklist-list","data-open":false})).append(b("<div>",{"class":"lac-checklist-error"}))).append(b("<div>",{"class":"lac-checklist-bottom"}).append(b("<div>",{"class":"lac-checklist-tags"}))).append(b("<div>",{"class":"lac-checklist-values"})).insertAfter(this.element);if(this.element.css("display")=="none"){this.container.hide()}this.element.hide();this.selectList=this.container.find(".lac-checklist-list");this.tagsList=this.container.find(".lac-checklist-tags");this.textInput=this.container.find(".lac-checklist-input")},_manageModel:function(){if(this.options.shared){if(b("#sha-"+this.options.shared).length){this.model=b("#sha-"+this.options.shared)}else{this.model=b("<input>",{id:"sha-"+this.options.shared,type:"hidden"}).appendTo(b("body"))}}else{this.model=this.element}b(this.model).lac_model({mode:"research",origin:this});if(this.initList!=undefined){b(this.model).lac_model("returnLabels",this.initList,this)}},_changeElement:function(a){this.checkedList={};this.selectList.empty();this.tagsList.empty();this.initList=undefined;if(this.element.data("value")!=undefined&&this.element.data("value").trim()!=""){this.initList=lwsBase64.toObj(this.element.data("value"))}if(this.initList==undefined||!this.initList.length){this._updateList()}b(this.model).lac_model("returnLabels",this.initList,this)},addToSource:function(e,f){if(f==undefined){f=false}var a=[];a[e]=e;b(this.model).lac_model("addToSource",a,this);if(f!=false&&f!=undefined){this.resList=b(this.model).lac_model("getSource");this.checkedList[e]=e;this._setResList(this.resList);this._fillTagList();this._updateList()}},_openCheckList:function(){this.resList=b(this.model).lac_model("getSource");if(jQuery.isEmptyObject(this.resList)){this._ajaxLoading();b(this.model).lac_model("research","",this,true)}else{this._setResList(this.resList)}this.container.find(".lac-checklist-close").show();this.selectList.data("open",true);this.selectList.css("display","flex");this._calcColumns()},_closeCheckList:function(){if(this.selectList.data("open")==true){this.container.find(".lac-checklist-searchdiv").animate({width:"26px"},500);this.container.find(".lac-checklist-basebutton").html(this.options.placeholder);this.container.find(".lac-checklist-close").hide();this.selectList.data("open",false);this.selectList.css("display","none");this.textInput.val("");this.resList=b(this.model).lac_model("getSource");this._setResList(this.resList)}},_calcColumns:function(){var a=3;this.selectList.find(".lac-checklist-item").css("width",this.colWidths[a]);this.selectList.find(".lac-checklist-item").each(function(){if(b(this).outerHeight()>40){a=2}});this.selectList.find(".lac-checklist-item").css("width",this.colWidths[a])},_openSearch:function(){this.container.find(".lac-checklist-searchdiv").animate({width:"340px"},500);this.container.find(".lac-checklist-basebutton").html("");if(!this.selectList.data("open")){this.container.find(".lac-checklist-close").show();this.selectList.data("open",true);this.selectList.css("display","flex");this._calcColumns()}this.textInput.focus()},_resetSearch:function(){this.textInput.val("");this.resList=b(this.model).lac_model("getSource");this._setResList(this.resList);this.textInput.focus()},_recursiveList:function(k){var a=[];for(var l in k){if(k[l].group!=undefined){retour=this._recursiveList(k[l].group);if(retour.length>0){if(retour[0][0].className!="lac-checklist-optgroup"){var i=b("<div>",{"class":"lac-checklist-optgroup","data-value":k[l].value,html:k[l].label});a.push(i)}a=b.merge(a,retour)}}else{this.selectIndex+=1;var j="";var h=" lws-icon-checkbox-unchecked";if(this.checkedList[k[l].value]!=undefined){j=" lac-checklist-item-selected";h=" lws-icon-checkbox-checked"}var i=b("<div>",{"class":"lac-checklist-item lac-item-"+l+j,"data-value":k[l].value}).append(b("<div>",{"class":"lac-checklist-item-cb"+h})).append(b("<div>",{"class":"lac-checklist-item-label",html:k[l].label}));a.push(i)}}return a},_setResList:function(f){this.selectList.empty();this.currentIndex=-1;this.selectIndex=-1;var e=this._recursiveList(f);for(var a=0;a<e.length;a++){e[a].appendTo(this.selectList)}if(this.showMore){this._addShowMoreButton()}},_selectItem:function(f,e){this.preventNext=true;var a=b(f.currentTarget);if(a.hasClass("lac-checklist-item-selected")){a.removeClass("lac-checklist-item-selected");a.find(".lac-checklist-item-cb").removeClass("lws-icon-checkbox-checked").addClass("lws-icon-checkbox-unchecked");delete this.checkedList[a.data("value")]}else{a.addClass("lac-checklist-item-selected");a.find(".lac-checklist-item-cb").removeClass("lws-icon-checkbox-unchecked").addClass("lws-icon-checkbox-checked");this.checkedList[a.data("value")]=a[0].innerText}this._fillTagList();this._updateList()},_manageSearch:function(a){if(this.textInput.val()!=""){b(this.model).lac_model("research",this.textInput.val())}else{if(a[0]!="Tab"){this._resetSearch()}}},_manageKeys:function(a,d){if(a.key=="Backspace"||a.key=="Delete"||a.key=="Suppr"){}if(a.key=="Escape"||a.key=="Enter"||a.key=="Tab"){this._closeCheckList()}},_manageFocus:function(a){if(this.selectList.data("open")==true){if(b(a.originalEvent.target).closest(".lac-checklist-wrapper").length==0){this._closeCheckList()}}},_showError:function(a){this.container.find(".lac-checklist-error").html(a).show().delay(1000).fadeOut(500)},_addShowMoreButton:function(){this.showMoreButton=b("<div>",{"class":"lac-checklist-showmore"}).append(b("<div>",{"class":"lac-checklist-smicon lws-icon-plus"})).append(b("<div>",{"class":"lac-checklist-smtext",text:"Show More"})).appendTo(this.selectList)},_showMore:function(a,d){b(this.model).lac_model("showMoreResults",this)},_ajaxLoading:function(){this.textInput.addClass("lac-loading")},_resultChanged:function(d){this.textInput.removeClass("lac-loading");if(d[1]=="ok"){if(!jQuery.isEmptyObject(d[0])){this.resList=d[0];this.showMore=d[2];this._setResList(this.resList);this.selectList.data("open",true);this.selectList.css("display","flex");this._calcColumns()}else{this.resList=[];this.selectList.empty();this.selectList.data("open",false);this.selectList.hide()}}else{if(d[1]=="init"){if(!jQuery.isEmptyObject(d[0])){var a=this;b.each(d[0],function(f,c){a.checkedList[c.value]=c.label});this.resList=b(this.model).lac_model("getSource");this.showMore=d[2];this._setResList(this.resList);this._fillTagList();this._updateList()}}else{this.resList=d[0];this._setResList(this.resList);this._showError(d[1])}}},_fillTagList:function(){this.tagsList.empty();var a=this;b.each(this.checkedList,function(f,e){b("<div>",{"class":"lac-tag-wrapper","data-value":f}).append(b("<div>",{"class":"lac-tag-text",text:e})).append(b("<a>",{"class":"lac-tag-remove lws-icon-cross"})).appendTo(a.tagsList)})},_delTag:function(d){var a=b(d.currentTarget).parent();delete this.checkedList[a.data("value")];a.remove();this._updateList();this._setResList(this.resList)},_updateList:function(){var a=this.container.find(".lac-checklist-values");a.empty();var d=this;keyTable=[];b.each(this.checkedList,function(f,c){b("<input>",{type:"hidden",name:d.name+"[]",value:f,"data-lw_dependant":d.name}).appendTo(a);keyTable.push(f)});this.element.data("value",lwsBase64.fromObj(keyTable))}})})(jQuery);jQuery(function(b){b(".lac_checklist").lac_checklist()});