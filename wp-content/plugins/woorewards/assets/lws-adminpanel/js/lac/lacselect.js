(function(b){b.widget("lws.lac_select",{options:{classe:"",name:"",placeholder:"",shared:false,delay:300,minlength:1,minoptions:2,minsearch:1,showMore:false,mode:"autocomplete",required:false,allownew:false},_create:function(){this._setOptions();this._createStructure();this.currentIndex=-1;this.flagAutocomplete=false;this.inHouse=false;this.initValue=(this.element.val()!=undefined)?[this.element.val()]:undefined;this.resLoad={};this.resLoad.target=this;this.resLoad.fn=this._ajaxLoading;this.resChange={};this.resChange.target=this;this.resChange.fn=this._resultChanged;this._manageModel();if(this.element.val()==undefined||this.element.val().length==0){this.resList=b(this.model).lac_model("getSource");if(!jQuery.isEmptyObject(this.resList)){this._setResList(this.resList)}}this._manageEvents();var a=this;var e;var f=[];this.container.keyup(function(d,c){f[0]=d.key;f[1]=d.keyCode;sentData=[f];e&&clearTimeout(e);e=setTimeout(a._bindD(a._manageSearch,a,sentData),a.options.delay)})},_bind:function(a,d){return function(){return a.apply(d,arguments)}},_bindD:function(a,f,e){return function(){return a.apply(f,e)}},_setOptions:function(){if(this.element.data("placeholder")!=undefined){this.options.placeholder=this.element.data("placeholder")}if(this.element.data("required")!=undefined){this.options.required=this.element.data("required")}if(this.element.data("delay")!=undefined){this.options.delay=this.element.data("delay")}if(this.element.data("class")!=undefined){this.options.classe=this.element.data("class")}if(this.element.data("name")!=undefined){this.options.name=this.element.data("name")}if(this.element.data("shared")!=undefined){this.options.shared=this.element.data("shared")}if(this.element.data("mode")!=undefined){this.options.mode=this.element.data("mode")}if(this.element.data("allownew")!=undefined){this.options.allownew=(this.element.data("allownew").trim().length>0)}},_destroy:function(){if(this.container.css("display")!="none"){this.element.show()}this.container.remove()},_createStructure:function(){var a="";if(this.element.hasClass("lws-ignore-confirm")){a="lws-ignore-confirm "}$reqborder=(this.options.required)?"lws-reqborder":"";this.container=b("<div>",{"class":"lac-select-wrapper ",tabIndex:"-1","data-uuid":this.uuid}).append(b("<div>",{"class":"lac-select-combo "+$reqborder}).append(b("<input>",{"class":a+"lac-select-input "+this.options.classe,tabIndex:"0",placeholder:this.options.placeholder,name:this.options.name})).append(b("<div>",{"class":"lac-select-showmore lws-icon-eye-plus"})).append(b("<div>",{"class":"lac-select-ddbutton lws-icon-select_arrow_down"}))).append(b("<div>",{"class":"lac-select-list",tabIndex:"-1","data-open":false})).append(b("<div>",{"class":"lac-select-error"})).insertAfter(this.element);if(this.element.css("display")=="none"){this.container.hide()}this.element.hide();this.showMoreButton=this.container.find(".lac-select-showmore");this.selectList=this.container.find(".lac-select-list");this.textInput=this.container.find(".lac-select-input");this.textInput.prop("autocomplete","off");readonly=(this.options.mode==="select")?true:false;this.textInput.prop("readonly",readonly);if(this.options.required){this.textInput.lws_required()}},_manageEvents:function(){if(this.element.prop("disabled")){this.textInput.prop("disabled",true);this.container.find(".lac-select-ddbutton").addClass("lws-disabled");this.container.off()}else{this.container.find(".lac-select-ddbutton").removeClass("lws-disabled");this.container.on("click",".lac-select-ddbutton",this._bind(this._showHide,this));this.container.on("click",".lac-select-showmore",this._bind(this._showMore,this));this.container.on("click",".lac-select-item",this._bind(this._selectItem,this));this.container.on("focusout",this._bind(this._manageFocus,this));this.container.on("click",".lac-select-input",this._bind(this._manageInputFocus,this));this.container.on("keydown",this._bind(this._manageKeys,this));this.element.on("change",this._bind(this._changeElement,this))}},_manageModel:function(){if(this.options.shared){if(b("#sha-"+this.options.shared).length){this.model=b("#sha-"+this.options.shared)}else{this.model=b("<input>",{id:"sha-"+this.options.shared,type:"hidden"}).appendTo(b("body"))}}else{this.model=this.element}b(this.model).lac_model({mode:"autocomplete",origin:this});if(this.initValue!=undefined&&(this.initValue!=""||this.options.mode=="select")){b(this.model).lac_model("returnLabels",this.initValue,this,this.options.mode)}},_recursiveList:function(f){var a=[];var e=this;b.each(f,function(h,c){if(c.group!=undefined){retour=e._recursiveList(c.group);if(retour.length>0){if(retour[0][0].className!="lac-select-optgroup"){var d=b("<div>",{"class":"lac-select-optgroup","data-value":c.value,html:c.label});a.push(d)}a=b.merge(a,retour)}}else{e.selectIndex+=1;var d=b("<div>",{"class":"lac-select-item lac-item-"+e.selectIndex,"data-value":c.value,"data-label":c.label,"data-index":e.selectIndex});if(c.html!=undefined&&c.html!=""){d.html(c.html)}else{d.text(c.label)}a.push(d)}});return a},_setResList:function(f){this.selectList.empty();this.currentIndex=-1;this.selectIndex=-1;var e=this._recursiveList(f);for(var a=0;a<e.length;a++){e[a].appendTo(this.selectList)}this.container.find(".lac-select-item").removeClass("lac-highlighted")},_selectItem:function(a){item=b(a.currentTarget);this._changeValue(item.data("value"));this.textInput.val(item.data("label"));this.currentIndex=item.data("index");this._closeList()},_changeElement:function(a){if(this.inHouse===true){this.inHouse=false;this.textInput.focus()}else{if(this.element.val()!=""||this.options.mode=="select"){b(this.model).lac_model("returnLabels",[this.element.val()],this)}else{if(this.element.val()==""){this.textInput.val("")}}}},_changeValue:function(a){this.inHouse=true;this.element.val(a);this.element.trigger("change")},_showHide:function(a,d){if(!this.selectList.data("open")){if(this.options.mode=="select"){this._openList()}else{this.flagAutocomplete=true;b(this.model).lac_model("research",this.textInput.val(),this,true)}}else{this._closeList();return false}},_showMore:function(a,d){b(this.model).lac_model("showMoreResults",this)},_openList:function(){if(this.showMore){this.showMoreButton.show()}this.selectList.data("open",true);this.selectList.show()},_closeList:function(){this.showMoreButton.hide();this.selectList.data("open",false);this.selectList.hide()},_manageInputFocus:function(a){if(this.options.mode=="select"){if(!this.selectList.data("open")){this._openList()}else{this._closeList()}}},_manageFocus:function(a,f){if(!a.originalEvent){return}var e=b(a.originalEvent.relatedTarget).closest(".lac-select-wrapper");if(e.length>0&&e.data("uuid")==this.uuid){return}this._handleNewOrIncorrectValue();this._closeList()},_handleNewOrIncorrectValue:function(){if(this.textInput.val()!=""&&!this._isInResList(this.element.val(),this.textInput.val())){if(this.options.allownew!=undefined&&this.options.allownew==true){var d=this.textInput.val();var a=[];a[d]=d;b(this.model).lac_model("addToSource",a,this);this._changeValue(d)}else{this.textInput.val("");this._showError("Incorrect Value")}}},_isInResList:function(e,f){var a=false;b.each(this.resList,function(d,c){if(c.value==e&&c.label==f){a=true}else{if(c.group!=undefined){b.each(c.group,function(i,j){if(j.value==e&&j.label==f){a=true}})}}});return a},_manageSearch:function(a){if(a[0].length==1){this.currentIndex=-1;b(this.model).lac_model("research",this.textInput.val(),this)}},_showError:function(a){this.container.find(".lac-select-error").html(a).show().delay(1000).fadeOut(500)},_manageKeys:function(g,f){if(g.key=="ArrowDown"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex+1>this.selectIndex)?0:this.currentIndex+1;var h=this.container.find(".lac-item-"+this.currentIndex);h.addClass("lac-highlighted");this.textInput.val(h.data("label"));this.selectList.scrollTop(Math.floor(h.position().top)+Math.floor(this.selectList.scrollTop()));this._changeValue(h.data("value"));if(!this.selectList.data("open")){this._openList()}return false}if(g.key=="ArrowUp"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex-1<0)?this.selectIndex:this.currentIndex-1;var h=this.container.find(".lac-item-"+this.currentIndex);h.addClass("lac-highlighted");this.textInput.val(h.data("label"));this.selectList.scrollTop(Math.floor(h.position().top)+Math.floor(this.selectList.scrollTop()));this._changeValue(h.data("value"));if(!this.selectList.data("open")){this._openList()}return false}if(g.key=="Enter"||g.key=="Escape"||g.key=="Tab"){this._handleNewOrIncorrectValue();this._closeList()}if(g.key=="Backspace"||g.key=="Delete"||g.key=="Suppr"){this.currentIndex=-1;this._changeValue("");var a=this;setTimeout(function(){if(a.textInput.val().length==0){a.resList=b(a.model).lac_model("getSource");a._setResList(a.resList)}else{a.flagAutocomplete=true;b(a.model).lac_model("research",a.textInput.val(),a)}},50)}},_inputSelectRange:function(){if(this.textInput[0].setSelectionRange){var a=this.textInput.val();this.textInput.focus();var d=this.container.find(".lac-item-"+this.currentIndex);this.textInput.val(d.data("label"));this.textInput[0].setSelectionRange(a.length,this.textInput.val().length);this._changeValue(d.data("value"))}},_ajaxLoading:function(){this.textInput.addClass("lac-loading")},_resultChanged:function(a){this.textInput.removeClass("lac-loading");if(a[1]=="ok"){if(!jQuery.isEmptyObject(a[0])){this.resList=a[0];this._setResList(this.resList);if(!this.flagAutocomplete){this.currentIndex=0;this._inputSelectRange();this.container.find(".lac-item-"+this.currentIndex).addClass("lac-highlighted")}this.flagAutocomplete=false;this.showMore=a[2];if(!this.showMore){this.showMoreButton.hide()}this._openList()}else{this._closeList();this.selectList.empty()}}else{if(a[1]=="init"){if(!jQuery.isEmptyObject(a[0])){this.resList=a[0];this._setResList(this.resList);this.currentIndex=0;this.showMore=a[2];if(!this.showMore){this.showMoreButton.hide()}this.textInput.val(this.selectList.find(".lac-item-0").data("label"));if(this.options.mode=="select"){this.resList=b(this.model).lac_model("getSource");this._setResList(this.resList)}}}else{if(!jQuery.isEmptyObject(a[0])){this.resList=a[0];this._setResList(this.resList);this._showError(a[1])}else{this._closeList();this.selectList.empty()}}}},enableControl:function(){if(this.element.prop("disabled")==true){this.element.prop("disabled",false);this._manageEvents()}},disableControl:function(){if(this.element.prop("disabled")==false){this.element.prop("disabled",true);this._manageEvents()}},reInitSource:function(){if(!this.options.shared){b(this.model).lac_model("reInit",this);if(this.initValue!=undefined&&(this.initValue!=""||this.options.mode=="select")){b(this.model).lac_model("returnLabels",this.initValue,this,this.options.mode)}}}})})(jQuery);jQuery(function(b){b(".lac_select").lac_select()});