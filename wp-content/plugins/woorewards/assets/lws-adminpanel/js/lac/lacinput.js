(function(b){b.widget("lws.lac_input",{options:{classe:"",name:"",placeholder:"",delay:300,minsearch:1,minoption:2,minlength:1},_create:function(){this._setOptions();this._createStructure();this.currentIndex=-1;this.resLoad={};this.resLoad.target=this;this.resLoad.fn=this._ajaxLoading;this.resChange={};this.resChange.target=this;this.resChange.fn=this._resultChanged;this._manageModel();b(this.element).prop("autocomplete","off");this.resList=b(this.element).lac_model("getSource");this._setResList(this.resList);this.container.on("click",".lac-input-showmore",this._bind(this._showMore,this));this.container.on("click",".lac-input-item",this._bind(this._selectItem,this));this.container.on("blur",".lac-input-wrapper",this._bind(this._manageFocus,this));this.container.on("keydown",this._bind(this._manageKeys,this));var a=this;var e;var f=[];this.container.keyup(function(d,c){f[0]=d.key;f[1]=d.keyCode;sentData=[f];e&&clearTimeout(e);e=setTimeout(a._bindD(a._manageSearch,a,sentData),a.options.delay)})},_bind:function(a,d){return function(){return a.apply(d,arguments)}},_bindD:function(a,f,e){return function(){return a.apply(f,e)}},_setOptions:function(){if(this.element.data("placeholder")!=undefined){this.options.placeholder=this.element.data("placeholder")}if(this.element.data("required")!=undefined){this.options.required=this.element.data("required")}if(this.element.data("delay")!=undefined){this.options.delay=this.element.data("delay")}if(this.element.data("class")!=undefined){this.options.classe=this.element.data("class")}if(this.element.data("name")!=undefined){this.options.name=this.element.data("name")}if(this.element.data("shared")!=undefined){this.options.shared=this.element.data("shared")}},_createStructure:function(){$reqborder=(this.options.required)?"lws-reqinpborder":"";this.container=b("<div>",{"class":"lac-input-wrapper "+$reqborder,tabIndex:"-1"}).append(b("<div>",{"class":"lac-input-showmore lws-icon-eye-plus"})).append(b("<div>",{"class":"lac-input-list","data-open":false})).append(b("<div>",{"class":"lac-input-error"})).insertAfter(this.element);if(this.element.css("display")=="none"){this.container.hide()}this.element.addClass("lac-input-text").detach().prependTo(this.container);this.showMoreButton=this.container.find(".lac-input-showmore");this.selectList=this.container.find(".lac-input-list");this.textInput=this.container.find(".lac-input-text").addClass(this.options.classe);if(this.options.required){this.textInput.lws_required()}},_manageModel:function(){if(this.options.shared){if(b("#sha-"+this.options.shared).length){this.model=b("#sha-"+this.options.shared)}else{this.model=b("<input>",{id:"sha-"+this.options.shared,type:"hidden"}).appendTo(b("body"))}}else{this.model=this.element}b(this.model).lac_model({mode:"research",origin:this})},_recursiveList:function(g){var a=[];for(var h in g){if(g[h].group!=undefined){retour=this._recursiveList(g[h].group);if(retour.length>0){if(retour[0][0].className!="lac-input-optgroup"){var f=b("<div>",{"class":"lac-input-optgroup","data-value":g[h].value,html:g[h].label});a.push(f)}a=b.merge(a,retour)}}else{this.selectIndex+=1;var f=b("<div>",{"class":"lac-input-item lac-item-"+this.selectIndex,"data-value":g[h].value,"data-label":g[h].label,"data-index":this.selectIndex});if(g[h].html!=undefined){f.html(g[h].html)}else{f.text(g[h].label)}a.push(f)}}return a},_setResList:function(f){this.selectList.empty();this.currentIndex=-1;this.selectIndex=-1;var e=this._recursiveList(f);for(var a=0;a<e.length;a++){e[a].appendTo(this.selectList)}this.container.find(".lac-input-item").removeClass("lac-highlighted");this.textInput.outerWidth(this.selectList.outerWidth())},_selectItem:function(a,d){item=b(a.currentTarget);this.textInput.val(item.data("label"));this.currentIndex=item.data("index");this._closeList()},_showMore:function(a,d){b(this.model).lac_model("showMore",this)},_openList:function(){if(this.showMore){this.showMoreButton.show()}this.selectList.data("open",true);this.selectList.show()},_closeList:function(){this.showMoreButton.hide();this.selectList.data("open",false);this.selectList.hide()},_manageFocus:function(a,d){if(b(a.originalEvent.relatedTarget).closest(".lac-input-wrapper").length>0){return}this._closeList()},_showError:function(a){this.container.find(".lac-select-error").html(a).show().delay(1000).fadeOut(500)},_manageSearch:function(a){if(/[a-zA-Z0-9-_ ]/.test(String.fromCharCode(a[1]))){b(this.element).lac_model("research",this.textInput.val(),this)}},_manageKeys:function(g,f){if(g.key=="ArrowDown"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex+1>this.selectIndex)?0:this.currentIndex+1;var h=this.container.find(".lac-item-"+this.currentIndex);h.addClass("lac-highlighted");this.textInput.val(h.data("label"));this.selectList.scrollTop(Math.floor(h.position().top)+Math.floor(this.selectList.scrollTop()));if(!this.selectList.data("open")){this._openList()}}if(g.key=="ArrowUp"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=(this.currentIndex-1<0)?this.selectIndex:this.currentIndex-1;var h=this.container.find(".lac-item-"+this.currentIndex);h.addClass("lac-highlighted");this.textInput.val(h.data("label"));this.selectList.scrollTop(Math.floor(h.position().top)+Math.floor(this.selectList.scrollTop()));if(!this.selectList.data("open")){this._openList()}}if(g.key=="Enter"){this.currentIndex=-1;this.textInput.trigger("blur")}if(g.key=="Backspace"||g.key=="Delete"||g.key=="Suppr"){this._closeList();this.currentIndex=-1;var a=this;setTimeout(function(){if(a.textInput.val().length==0){a.resList=b(a.model).lac_model("getSource");a._setResList(a.resList)}},50)}},_ajaxLoading:function(){this.textInput.addClass("lac-loading")},_resultChanged:function(a){this.textInput.removeClass("lac-loading");if(a[1]!="ok"){this.resList=a[0];this._setResList(this.resList);this.showMore=a[2];if(!this.showMore){this.showMoreButton.hide()}this._showError(a[1])}else{if(!jQuery.isEmptyObject(a[0])){this.resList=a[0];this._setResList(this.resList);this.showMore=a[2];if(!this.showMore){this.showMoreButton.hide()}this._openList()}else{this.resList=[];this._closeList();this.selectList.empty()}}}})})(jQuery);jQuery(function(b){b(".lac_input").lac_input()});